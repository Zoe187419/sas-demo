


	/*
		Hiroshima Chromosome Aberration Example
	*/
 
	data hiroshima;
		input m t t65d_gamma t65d_neutron;
		label m = "Number of cells examined"
		      t = "Total aberrations"
			  t65d_gamma   = "T-65-D  gamma"
			  t65d_neutron = "T-65-D  neutron";
		z = t65d_gamma + t65d_neutron;
	datalines;
  100    0    0    0
  100    0    0    0
   30    0    0    0
   69   12  324   84
  100    8  221   82
  100    1    0    0
   36    0    0    0
  100    0   96   18
  100    0    0    0
   79    8  267  161
  100    1    0    0
   39    0    0    0
  100    2    0    0
  100    2    0    0
  100    7  173   46
  100    2    0    0
  100    0    1    0
  100    0    0    0
  100    7  135   29
  100    0    0    0
  100    1    0    0
  100    1    0    0
  100    3    0    0
  100    5  144   31
   82    9  153  103
   30    0  131   27
  100    5   31   13
  100    0    0    0
  100    0   66   38
  100    3    0    0
  100    6  158   38
  100   12  245   51
   30    2  125   30
  100   16  439  100
  100    9  161   38
  100    3   61   13
  100   11  439  154
  100   14  281  161
  100    7  203   48
  100    1   87   17
  100    0   84   18
   80    1   42    8
  100    2  122   28
  100    0    0    0
   30    0    0    0
  100    0    0    0
  100   17  203  146
  100    3  284   66
   70    0  439  161
  100    3    0    0
   53    1    0    0
  100    3    0    0
  100    5  159   31
  100    0    0    0
  100    2    0    0
  100    1    0    0
  100    9  212   54
  100   12  157   50
  100    0    0    0
  100    3   87   53
  100    2    0    0
  100    2  181  116
   82    1   75   37
   32    0   67   33
  100    2    0    0
  100    0    0    0
  100    1    0    0
  100    3  108   22
  100    6  118   43
  100    3  185   44
  100    0    0    0
  100    1    0    0
  100    0    0    0
  100    4  180   39
  100    0    0    0
  100    0    0    0
   30    0    0    0
  100   15  174   40
  100    2    0    0
  100    1    5    2
  100   20  218   47
   80    0   16    3
  100   15  142   65
  100    0   94   16
  100    1    0    0
  100    2    0    0
  100    0  126   66
  100    0    0    0
  100    1   12    5
  100    3    0    0
   90    4  197  132
  100   39  243  161
  100    0    0    0
  100    1    0    0
  100    2    0    0
   66    7  152   34
  100    3    0    0
  100    1    0    0
  100    5    0    0
  100    2    0    0
  100    4  439  161
  100    0    0    0
  100    7  317   65
  100    1    0    0
  100   19  439  161
   92    1   12    5
  100    3   66   15
  100    1   27   10
  100   15  149  101
  100    5   59   10
  100    2    0    0
   50    3  308   77
  100    1    0    0
  100    6  131   33
  100    5   71   14
  100    2   34    8
  100    3  165   34
  100    7  101   22
  100    5   74   44
   54    7  316   75
  100    6  160   38
  100    6   63   13
  100    0   30    5
  100   24  384   81
  100    6   32   15
  100    3   43    9
   50    0   46    8
  100    3  119   24
  100    0  113   23
  100    5   96   21
   37    1  187  115
  100    5  109   25
  100    3  117   27
  100    3  335   70
  100   28  131   82
  100   11  395   97
  100    5  137   63
  100   21  439  161
  100    2   10    3
  100   15  296   92
   63    0   89   16
  100    4   30   14
   47    1  439  161
  100    7  206   46
  100    2    0    0
  100    0  439  159
  100    7  211   44
  100    1  377  136
  100    5  221   47
  100   17  324  161
  100    0   55    9
  100   40  403  102
  100    3    0    0
  100    8  172   37
   56    3  100   55
  100   13  245   70
  100   11  128   33
   78    5  214   52
  100    7   65   10
  100    0  112   29
  100   10  249  112
   87    5  186   40
  100    1    2    1
  100    7  265   60
  100    3  376   83
  100    2  149   25
  100    5   37   19
  100   16  372   97
  100    6  144   36
  100    2    0    0
  100    3  120   54
  100    0  155  106
  100    5  179   38
  100    2    0    0
  100    1    0    0
  100   24  224   80
  100    7   93   54
   66    0    2    1
   50    4  112   21
  100    2   90   42
  100    6   85   18
  100    0    0    0
   79    4  103   23
  100    7  148   35
  100   18  279   72
  100    5  208   51
  100   13  262   57
   32    1  176   41
  100    8  173   38
   30    1  155   38
  100   18  202   50
  100    7   58   25
   67    1  133   28
  100   19  257   67
   76    0    3    1
  100   25  434  120
  100   44  306  161
  100    7  152   43
  100    6  177   37
  100    9   65   38
  100   10  100   27
   42    2  115   31
   70    1   28    6
  100   16   73   17
  100    2   58   14
   35    0   89   51
  100    5  339   85
  100    5  171   87
  100    4  128   38
  100    4  136   24
  100    7   67   11
  100    5  291   81
  100    4  162   33
  100    7   47    7
  100   18  296   71
  100    0   92   19
  100    0    0    0
  100    2  106   19
  100    8   98   35
  100    1    9    4
  100   10  305   60
  100    4  302   69
  100    2    0    0
  100    1   39   10
  100    1   93   18
  100   14  379  103
  100    0    0    0
  100    1  108   23
  100    0    2    1
  100    0    0    0
  100   22  392  161
  100   16  379   95
  100    0   66   38
  100    1   54   17
  100   10   96   28
  100    0    0    0
   32    0    0    0
  100    7  243   57
  100    0    0    0
  100    1    0    0
  100    1    0    0
  100    1    0    0
  100    9  100   22
   50    0    0    0
   80    5  257  144
   30    0    0    0
  100    0    0    0
  100    1    0    0
  100    5  186   58
  100    0    0    0
  100    1    0    0
  100   12  100   22
  100    0    0    0
  100    9   61   16
  100    6   99   62
  100    2   18    2
  100    2  134   26
  100    4  377  161
  100    1    0    0
  100    2    0    0
   31    8  203  133
  100    0    0    0
  100    2    0    0
  100    0    0    0
  100    1    0    0
  100    3    0    0
  100    1  136   23
  100    8  117   28
  100    1    9    3
  100    1    0    0
  100    2    0    0
  100    4  328  100
  100    7   89   19
  100    3    0    0
  100   19  439  161
  100    2   86   48
  100    1    0    0
  100    1    0    0
  100    2   32    5
  100    7  345   96
   50    0   54   10
  100    7  126   83
  100    0    0    0
   51    3   91   40
  100    2    0    0
   74    1  238   54
  100   13  221   53
  100    0    0    0
   46    6  150   88
  100    1    0    0
  100    2   13    1
  100    4  384  140
  100    0   91   21
   30    0   95   55
  100    0    0    0
  100    1    0    0
   33    3  439  161
   31    1    0    0
  100    3    0    0
  100   12  250  103
  100    3    0    0
  100    1    7    3
  100    1    0    0
  100    0    0    0
  100    0    0    0
  100    0    0    0
   94    3   99   23
   46   12  235   56
  100    7  247   60
  100    2   86   18
   80    5  331   80
  100    1    0    0
  100    1    0    0
   30    0    0    0
   42    0   86   36
   35    0    0    0
  100    0    0    0
  100    1    0    0
  100    0    0    0
  100    3    0    0
  100    0    0    0
  100    1    0    0
   90    8  139   27
  100    3  101   25
  100    0    0    0
   60    4  314   78
  100    1    0    0
  100    1    0    0
  100    3    0    0
  100    6  324   78
  100   20  301   82
  100    0    0    0
  100    1    0    0
  100   15  165   48
   90    1    7    3
  100    0    0    0
  100   35  384  100
   56    0    0    0
  100   12  243  161
   34    2  191   45
  100    7  145   29
  100   13  182   45
   32    0    0    0
  100    1    0    0
   91    2   14    3
  100    1   49   27
  100    1    0    0
  100    0    0    0
  100    0    0    0
  100    0    0    0
   84    2    0    0
  100    2    0    0
   80    1    0    0
  100    2    0    0
  100    1    0    0
  100    0    0    0
  100    0    0    0
  100    2    4    1
  100   14  254   59
  100    0    0    0
  100    1    0    0
  100    0    0    0
  100    2    0    0
  100    2    0    0
  100    2    0    0
  100    0    0    0
  100    7   47    8
  100    2    0    0
  100    0    0    0
  100    1    0    0
  100    2    0    0
   88    2    0    0
   53    1   40    6
  100    4   15    2
  100    0    0    0
  100    1    0    0
   30    3  212   60
  100    1    0    0
  100    3  155  106
  100    3   72   39
  100    9  149   41
  100    0    0    0
   70    2    2    0
  100    6  287   60
  100    6    0    0
  100    3    0    0
  100   11  211   52
  100    4  108   23
  100    2    0    0
  100    0    0    0
  100   17   93   15
   68    0    0    0
  100   40  428  161
  100    9  131   30
  100   12  248  161
  100    7  112   28
  100    5  307   92
  100    7   95   17
  100    0   10    1
  100    7   88   19
  100    0    0    0
  100   16  167  116
   45    2  210   57
  100   14  203   55
  100    2    0    0
  100    1    0    0
  100    4   85   20
   92   18  439  161
  100    1    0    0
   80    8  117   28
  100    6  104   27
  100    2    0    0
  100    2  439  161
  100    0    0    0
  100    2    0    0
  100    0    0    0
  100   13  190   39
   65    1    0    0
  100    2    0    0
  100   16  171   91
  100    3    0    0
  100    0    0    0
  100    3   25    9
  100    3    0    0
  100   18  139   93
  100    0    0    0
  100    2    0    0
  100    1    0    0
   50    2    0    0
  100    1   12    2
  100    1    4    1
  100    4    0    0
  100    5  101   30
  100    4  439  161
  100    9  353   95
  100    1    0    0
   30    0   82   47
  100   10  216   64
  100    8  439  161
  100    1    0    0
  100   10  220   50
  100    6  357   83
  100    0    0    0
  100    0  117   76
   93    3   35    7
  100   23  245   73
   48    2  324  108
  100    1    0    0
   50    0    0    0
   95    2    0    0
  100    2    0    0
  100    7  140   32
  100    1    0    0
  100    4    0    0
   42    4   99   27
   60    3    0    0
  100    6  120   35
  100   14  373  133
  100   15  330  108
   93   11  327   98
  100    9  170   42
   80   19  439  115
  100   14  439  161
  100    0    0    0
  100    2  148   30
  100    0    0    0
  100   14  138   68
  100   18  123   28
  100   17   87   46
  100    1    0    0
  100   21  384  161
  100    1    0    0
  100    1  257   59
  100    2  100   30
  100    3    0    0
  100   10  115   29
  100    1    0    0
  100    5   94   16
  100    1   30    6
  100    1   32    8
  100    2    0    0
   63    7  277   60
  100    2    0    0
  100    2  159   34
   53    6  251   78
  100    1    0    0
  100    3    0    0
  100   18  230  161
  100    1    0    0
  100    2   65   38
  100    1    0    0
   81    2    0    0
  100    8  149   33
  100   26  222   60
   32    3   40   18
  100    1    0    0
  100    0    0    0
  100    1    0    0
  100    4  142   34
  100    2  125   49
  100    1   92   16
  100    3  174   39
  100    0    0    0
   38    1    0    0
   82    1    0    0
  100    3    0    0
   35    0    0    0
  100   15  157   38
  100    1    0    0
  100    1    0    0
  100    0    0    0
  100    1   97   60
  100    5   96   60
  100    2    0    0
   34    0    0    0
  100    1  112   22
  100    3  106   27
  100   12  214   53
  100    2  439  161
  100    1    0    0
   30    0   33    6
  100   19  103   20
  100    4  141   39
   50    0    0    0
  100    0    0    0
  100    2    0    0
  100    0    0    0
  100   47  244  100
  100   16  439  161
  100   22  439  161
  100   28  318  118
  100   16  404  124
  100    0   91   20
  100   15  269   72
  100    6  160   38
   30    0  216   61
  100   14   84   50
  100   11  372   90
  100    7  237  137
   60    4  186   52
  100    7   44   12
  100    3    0    0
  100   31  439  144
  100    1    0    0
  100    6  163   39
  100    2    0    0
  100    0   15    3
  100    7  155   27
  100    0   15    6
  100    2  124   29
   50    0   58   11
  100    1    0    0
   70   18  234   51
  100    2  197   48
  100    1    0    0
  100    2    0    0
  100    0    0    0
  100    2  196   99
  100    2    0    0
  100    5  106   23
  100   27  439  161
   78   22  301   76
  100    2    0    0
  100    4   68   38
  100    3  136   35
   33    1  102   21
  100    4  136   28
  100    6  102   23
  100    1   98   19
   86    1    7    2
  100    5  197   43
  100    8  284   60
  100    0    0    0
  100   27  328  161
  100    4  119   33
  100   19  196   43
  100    2    0    0
  100    2    0    0
  100    2    0    0
  100    8  115   31
  100    8  152   39
  100   11  165   42
  100    2  184   32
  100    1   91   18
  100    7  152   28
  100    5    0    0
  100    2  265   50
  100    2    2    1
  100   31  358   88
  100   14  178  125
  100    7  177   50
  100    0    0    0
  100    2    0    0
  100    0    0    0
  100   17  362   91
  100   22  360   84
  100    2   10    4
  100    3    0    0
  100    2    0    0
  100    4    0    0
  100   11  301   75
  100    9  321   82
  100   21  210  152
  100    0    0    0
  100    1    0    0
  100    8   85   17
  100    0   96   15
   40    2  227   56
  100    3  175   38
  100    4  205   54
   45    0    0    0
   37    0    0    0
   50    1    0    0
  100    4    0    0
  100    0    0    0
   30    0    0    0
   65    4    0    0
  100    1    0    0
  100    7   69   14
  100    3    0    0
  100    3    0    0
  100    7  138   31
  100    2   92   38
  100    3    0    0
  100    0    0    0
  100    4  133   30
  100    1    0    0
   33    0    0    0
  100    0    0    0
  100    1    0    0
  100    0    0    0
  100    1    0    0
   85    0    0    0
  100    8  176   38
  100    1    0    0
  100    1   11    4
  100    0   16    2
  100    0    0    0
   30    4  126   30
   90    0    0    0
  100    2  117   23
  100    3    0    0
  100    0    0    0
  100    2    0    0
  100    1    0    0
   80    2   79   41
   65    0    0    0
   40    1    0    0
	 ;

 	proc stdize data=hiroshima out=hiroshima;
		var z;
	run;

	data hiroshima;
		set hiroshima;
		zz   = z * z;
	run;

	ods html;
	ods graphics on;

	title "*** Beta-binomial fit ***";;	
	ods output Dimensions=Dimensions;
	proc nlmixed data=hiroshima;
		parms b0=0 b1=0 b2=0 a0=0 a1=0 a2=0;
		rho   = 1 / (1 + exp(-a0-a1*z-a2*zz));
		xbeta = b0 + b1*z + b2*zz;
		pi    = 1 / ( 1 + exp( - xbeta ) );
		theta = 1 / rho / rho - 1;
		c     = lgamma(m+1) - lgamma(t+1) - lgamma(m-t+1);
		ll    = c + lgamma(theta)   + lgamma(t+theta*pi) + lgamma(m-t+theta*(1-pi))
		          - lgamma(m+theta) - lgamma(theta*pi)   - lgamma(theta*(1-pi));
		model t ~ general( ll );
			predict pi    out=pi_bb;
			predict rho   out=rho_bb;
	run;

	data Dimensions;
		set Dimensions;
		if Descr = "Parameters" then call symput('nparms_bb',trim(left(Value)));	
		*--- "nparms" is number of parameters;
	run;

	data pi_bb;
		set pi_bb;
		keep Pred;
	run;

	data rho_bb;
		set rho_bb;
		keep Pred;
	run;

	title "*** Random-clumped Binomial fit ***";	
	ods output Dimensions=Dimensions;
	proc nlmixed data=hiroshima;
		parms b0=0 b1=0 b2=0 a0=0 a1=0 a2=0;
		rho   = 1 / (1 + exp(-a0-a1*z-a2*zz));
		xbeta = b0 + b1*z + b2*zz;
		pi    = 1 / ( 1 + exp( - xbeta ) );
		pic   = 1 - pi;
		p1    = ( 1 - rho )*pi + rho;
		p1c   = 1 - p1;
		p2    = p1 - rho;
		p2c   = 1 - p2;
		c     = lgamma(m+1) - lgamma(t+1) - lgamma(m-t+1);
		ll    = c + log( pi*p1**t*p1c**(m-t)  +  pic*p2**t*p2c**(m-t) );
		model t ~ general( ll );
			predict pi    out=pi_rcb;
			predict rho   out=rho_rcb;
	run;

	data Dimensions;
		set Dimensions;
		if Descr = "Parameters" then call symput('nparms_rcb',trim(left(Value)));	
		*--- "nparms" is number of parameters;
	run;

	data pi_rcb;
		set pi_rcb;
		keep Pred;
	run;

	data rho_rcb;
		set rho_rcb;
		keep Pred;
	run;

	title;
	%GOF_BB_RCB_Distributions(hiroshima,"Hiroshima Chromosome Aberration Example");

	ods graphics off;
	ods html close;






